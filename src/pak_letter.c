#include "pak_letter.h"

#include <errno.h>
#include <stdio.h>
#include <string.h>

#include <libdragon.h>

/* A character using the game's special encoding */
typedef unsigned char dnm_char;

typedef struct
{
  dnm_char name[6];
  dnm_char town[6];
  unsigned short id;
  unsigned short town_id;
  unsigned char flags;
  unsigned char unused;
} dnm_letter_person_t;

typedef struct
{
  dnm_letter_person_t to;
  dnm_letter_person_t from;
  unsigned short present;
  unsigned char flags;
  unsigned char name_offset;
  unsigned char special_id;
  unsigned char stationery;
  dnm_char header[10];
  dnm_char body[112];
} dnm_letter_t;

typedef struct
{
  unsigned short checksum;
  dnm_char box_names[8][10];
  dnm_letter_t letters[160];
} dnm_mailbox_t;

static const dnm_char FAMICOM_BOX_NAMES[8][10] =
{
  { 0x0C, 0x0C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20 },
  { 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20 },
  { 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20 },
  { 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20 },
  { 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20 },
  { 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20 },
  { 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20 },
  { 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20 }
};

static const dnm_letter_t FAMICOM_LETTER =
{
  {
    { 0x55, 0x73, 0x65, 0x72, 0x20, 0x20 },
    { 0x4E, 0x36, 0x34, 0x20, 0x20, 0x20 },
    0xF000,
    0x3000,
    0x00,
    0x00
  },
  {
    { 0x4B, 0x65, 0x69, 0x74, 0x68, 0x20 },
    { 0x46, 0x69, 0x74, 0x4A, 0x75, 0x62 },
    0xF001,
    0x3000,
    0x00,
    0x00
  },
  0x1D44, /* Present: Famicom */
  0x00,
  0x00,
  0x00,
  0x00,
  { 0x41, 0x20, 0x67, 0x69, 0x66, 0x74, 0x11, 0x20, 0x20, 0x20 },
  {
    0x50, 0x6C, 0x65, 0x61, 0x73, 0x65, 0x20, 0x70, 0x6C, 0x61, 0x63, 0x65,
    0x20, 0x74, 0x68, 0x69, 0x73, 0x20, 0x45, 0x61, 0x6D, 0x69, 0x63, 0x6F,
    0x6D, 0x20, 0x69, 0x6E, 0x20, 0x79, 0x6F, 0x75, 0x72, 0x20, 0x68, 0x6F,
    0x6D, 0x65, 0x2C, 0x20, 0x73, 0x61, 0x76, 0x65, 0x2C, 0x20, 0x61, 0x6E,
    0x64, 0x20, 0x72, 0x65, 0x74, 0x75, 0x72, 0x6E, 0x20, 0x74, 0x6F, 0x20,
    0x44, 0x6F, 0x72, 0x74, 0x69, 0x6D, 0x65, 0x72, 0x11, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20
  }
};

int pak_write_letter(void)
{
  /* Sanity check; should never occur */
  if (sizeof(dnm_mailbox_t) != 26322 || sizeof(dnm_letter_t) != 164)
    return -1;
  else if (!cpak_mount(JOYPAD_PORT_1, "cpak1:/"))
  {
    FILE *file;
    cpak_stats_t stats;
    dnm_mailbox_t mailbox;
    size_t bytes_written;
    unsigned short checksum = 0;
    unsigned i;

    /* Initialize mailbox */
    memset(&mailbox, 0x20, sizeof(mailbox));
    memcpy(mailbox.box_names, FAMICOM_BOX_NAMES, sizeof(FAMICOM_BOX_NAMES));
    memcpy(&mailbox.letters[0], &FAMICOM_LETTER, sizeof(FAMICOM_LETTER));

    /* Compute mailbox checksum */
    for (i = 2; i < sizeof(mailbox); i++)
      checksum += ((unsigned char*)&mailbox)[i];
    mailbox.checksum = checksum;

    /* Write mailbox to Controller Pak */
    file = fopen("cpak1:/NAFJ.01/DOUBUTSUNOMORI.B", "wb");
    if (!file)
    {
      cpak_unmount(JOYPAD_PORT_1);
      printf("Failed to open Controller Pak file: %s\n", strerror(errno));
      return -2;
    }
    bytes_written = fwrite(&mailbox, 1, sizeof(mailbox), file);
    if (bytes_written != sizeof(mailbox))
    {
      fclose(file);
      cpak_unmount(JOYPAD_PORT_1);
      printf("Failed to write to Controller Pak file: %s\n", strerror(errno));
      return -3;
    }
    fclose(file);

    cpak_get_stats(JOYPAD_PORT_1, &stats);
    printf("Letter successfully saved to Controller Pak.\n");
    printf("Bytes written: %u\n", bytes_written);
    printf("Pages used: %i\n", stats.pages.used);
    printf("Notes used: %i\n", stats.notes.used);
    cpak_unmount(JOYPAD_PORT_1);

    return 0;
  }

  return -1;
}
